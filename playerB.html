<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>乙頁面</title>
</head>
<body>

<h2>乙（實驗者）</h2>
<div id="info"></div>

<input id="catchB" type="number" min="0">
<button onclick="submitB()">送出</button>

<p id="status"></p>
<p id="result"></p>

<script>
let experimenterAccount = sessionStorage.getItem("experimenterAccount");
if(!experimenterAccount){ alert("請先登入乙帳號"); location.href="index.html"; }

let subjectId = sessionStorage.getItem("subjectId") || "UNKNOWN";

let game = {
  day:1, maxDays:20, totalFish:100,
  scoreA:0, scoreB:0,
  inputA:null, inputB:null,
  records:[]
};

function submitB(){
  let val = Number(document.getElementById("catchB").value);
  if(val<0 || val>game.totalFish){ alert("輸入不合法"); return; }
  game.inputB = val;
  localStorage.setItem("inputB", val);
  document.getElementById("status").innerText="等待甲操作中…";
  checkResolve();
}

function checkResolve(){
  let inputA = Number(localStorage.getItem("inputA"));
  if(game.inputB !== null && !isNaN(inputA)){
    resolveDay(inputA);
  }
}

function resolveDay(inputA){
  game.inputA = inputA;
  let totalCatch = game.inputA + game.inputB;
  if(totalCatch>game.totalFish){ totalCatch = game.totalFish; }
  let remaining = game.totalFish - totalCatch;

  game.scoreA += game.inputA;
  game.scoreB += game.inputB;
  game.records.push({
    subjectId,
    experimenterAccount,
    day:game.day,
    fishBefore:game.totalFish,
    catchA:game.inputA,
    catchB:game.inputB,
    fishAfter:remaining*2,
    timestamp:new Date().toISOString()
  });

  game.day++;
  game.totalFish = remaining*2;
  game.inputA=null;
  game.inputB=null;
  localStorage.removeItem("inputA");
  localStorage.removeItem("inputB");

  if(game.day>game.maxDays){
    showFinal();
  } else {
    updateUI();
  }
}

function updateUI(){
  document.getElementById("info").innerHTML=`
    <p>乙帳號：${experimenterAccount}</p>
    <p>第 ${game.day} 天</p>
    <p>池塘總魚數：${game.totalFish}</p>
    <p>你目前捕到：${game.scoreB}</p>
  `;
  document.getElementById("status").innerText="";
}

function showFinal(){
  document.getElementById("result").innerHTML=`
    <h3>遊戲結束（20天）</h3>
    <p>甲捕到：${game.scoreA} 條魚</p>
    <p>乙捕到：${game.scoreB} 條魚</p>
    <pre>${JSON.stringify(game.records,null,2)}</pre>
  `;
}

updateUI();
</script>
</body>
</html>
